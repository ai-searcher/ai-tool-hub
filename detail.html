<script>
  (function() {
    'use strict';
    
    // Hilfsfunktion zum Laden der data.json
    async function loadToolData() {
      try {
        const response = await fetch('data.json');
        if (!response.ok) throw new Error('Netzwerkfehler');
        const json = await response.json();
        return json.tools || json; // akzeptiert beide Formate
      } catch (err) {
        console.error('Fehler beim Laden von data.json:', err);
        return null;
      }
    }
    
    // URL-Parameter auslesen
    const urlParams = new URLSearchParams(window.location.search);
    const toolId = urlParams.get('id');
    
    const loadingEl = document.getElementById('loadingState');
    const errorEl = document.getElementById('errorState');
    const contentEl = document.getElementById('detailContent');
    const panel = document.getElementById('detailPanel');
    
    if (!loadingEl || !errorEl || !contentEl || !panel) {
      console.error('Kritische Elemente fehlen im DOM');
      return;
    }
    
    if (!toolId) {
      loadingEl.style.display = 'none';
      errorEl.style.display = 'block';
      errorEl.querySelector('p').textContent = '❌ Keine Tool-ID angegeben.';
      return;
    }
    
    // Hilfsfunktion für Listen
    function fillList(containerId, listId, items) {
      const container = document.getElementById(containerId);
      const listEl = document.getElementById(listId);
      if (!container || !listEl) {
        console.warn(`Container oder Liste nicht gefunden: ${containerId} / ${listId}`);
        return;
      }
      
      if (items && Array.isArray(items) && items.length > 0) {
        listEl.innerHTML = '';
        items.forEach(item => {
          const li = document.createElement('div');
          li.className = 'detail-list-item';
          li.textContent = item;
          listEl.appendChild(li);
        });
        container.style.display = 'block';
      } else {
        container.style.display = 'none';
      }
    }
    
    // Daten laden und anzeigen
    loadToolData().then(tools => {
      if (!tools || !Array.isArray(tools)) {
        throw new Error('Daten konnten nicht geladen werden');
      }
      
      // Tool mit passender ID suchen
      const tool = tools.find(t => String(t.id) === String(toolId));
      
      if (!tool) {
        throw new Error(`Tool mit ID ${toolId} nicht gefunden`);
      }
      
      // Kategorie setzen (für Farbanimation)
      const category = tool.category || 'other';
      panel.setAttribute('data-category', category);
      
      // Basisfelder befüllen – mit Prüfung auf Existenz
      const titleEl = document.getElementById('toolTitle');
      const descEl = document.getElementById('toolDescription');
      const catEl = document.getElementById('toolCategory');
      const providerEl = document.getElementById('toolProvider');
      const ratingEl = document.getElementById('toolRating');
      const linkEl = document.getElementById('toolLink');
      const providerContainer = document.getElementById('providerContainer');
      const ratingContainer = document.getElementById('ratingContainer');
      
      if (!titleEl || !descEl || !catEl || !providerEl || !ratingEl || !linkEl || !providerContainer || !ratingContainer) {
        console.error('Wichtige Elemente für die Anzeige fehlen');
        return;
      }
      
      titleEl.textContent = tool.title || 'Unbekannt';
      descEl.textContent = tool.description || 'Keine Beschreibung verfügbar.';
      catEl.textContent = (category.charAt(0).toUpperCase() + category.slice(1));
      providerEl.textContent = tool.provider || 'Unbekannt';
      ratingEl.textContent = tool.rating ? `★ ${tool.rating.toFixed(1)}` : '–';
      linkEl.href = tool.link || '#';
      
      // Provider und Rating nur anzeigen, wenn vorhanden
      providerContainer.style.display = tool.provider ? 'flex' : 'none';
      ratingContainer.style.display = tool.rating ? 'flex' : 'none';
      
      // Neue Felder befüllen
      fillList('strengthsContainer', 'strengthsList', tool.strengths);
      fillList('useCasesContainer', 'useCasesList', tool.useCases);
      fillList('promptExamplesContainer', 'promptExamplesList', tool.promptExamples);
      fillList('promptTipsContainer', 'promptTipsList', tool.promptTips);
      
      // Ladezustand ausblenden, Inhalt anzeigen
      loadingEl.style.display = 'none';
      contentEl.style.display = 'block';
      
    }).catch(err => {
      console.error(err);
      loadingEl.style.display = 'none';
      errorEl.style.display = 'block';
      errorEl.querySelector('p').textContent = '❌ ' + err.message;
    });
    
    // Schließen-Button: zurück zur vorherigen Seite
    const closeBtn = document.getElementById('closeButton');
    if (closeBtn) {
      closeBtn.addEventListener('click', function() {
        window.history.back();
      });
    } else {
      console.warn('Schließen-Button nicht gefunden');
    }
    
  })();
</script>